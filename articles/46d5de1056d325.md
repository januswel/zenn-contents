---
title: "Storybook test runner ã§ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹"
emoji: "ğŸ‘€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["test", "storybook", "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ"]
published: true
---

:::message
ç‰¹ã«ç†ç”±ãŒãªã„é™ã‚Š [Chromatic](https://www.chromatic.com/) ã‚’ä½¿ãŠã†ã€‚

ã“ã®æ–¹æ³•ã¯ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã†ã¾ãæ’®ã‚Œãªã„å ´åˆãŒã‚ã‚‹ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤‰æ›´ãŒã‚ã‚‹ãŸã³ã«ã‚³ãƒãƒ³ãƒ‰ã‚’æµã™å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆã¯é«˜ã„ã€‚ Chromatic ã®ã»ã†ãŒã‚³ã‚¹ãƒ‘è‰¯ã„ã€‚
:::

# è¨­å®š

Storybook test runner ã¯å†…éƒ¨ã§ Jest ã¨ Playwright ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚ Playwright å‹•ä½œã•ã›ã‚‹ OS ã«ã‚ˆã£ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœãŒç•°ãªã‚‹ã®ã§ã€ Dokcer ã‚’ä½¿ã£ã¦æ‰‹å…ƒã§ã‚‚ CI ã§ã‚‚åŒæ§˜ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœã¨ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

Playwright Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’ Storybook test runner ã§ä½¿ã†ãŸã‚ã®è¨­å®šã¯æ¬¡ã®è¨˜äº‹ãŒè©³ã—ãæ›¸ã„ã¦ãã‚Œã¦ã„ã‚‹ã€‚

https://zenn.dev/sterashima78/articles/a4b48c8baee778

ã“ã‚Œã‚’å‚è€ƒã«è¨­å®šã—ã¦ã„ãã€‚

```ts:/.storybook/test-runner.ts
import {
  getStoryContext,
  TestRunnerConfig,
  waitForPageReady,
} from '@storybook/test-runner';
import { toMatchImageSnapshot } from 'jest-image-snapshot';

const customSnapshotsDir = `${process.cwd()}/__snapshots__`;

const config: TestRunnerConfig = {
  setup() {
    expect.extend({ toMatchImageSnapshot });
  },


  async prepare({ page, browserContext, testRunnerConfig }) {
    const targetURL = 'http://host.docker.internal:6006';
    const iframeURL = new URL('iframe.html', targetURL).toString();

    if (testRunnerConfig?.getHttpHeaders) {
      const headers = await testRunnerConfig.getHttpHeaders(iframeURL);
      await browserContext.setExtraHTTPHeaders(headers);
    }

    await page.goto(iframeURL, { waitUntil: 'load' }).catch((err) => {
      if (err.message?.includes('ERR_CONNECTION_REFUSED')) {
        const errorMessage = `Could not access the Storybook instance at ${targetURL}. Are you sure it's running?\n\n${err.message}`;
        throw new Error(errorMessage);
      }

      throw err;
    });
  },

  async postVisit(page, context) {
    await waitForPageReady(page);

    const story = await getStoryContext(page, context);
    if (story.parameters.skipVisualRegressionTesting) {
      return;
    }

    const image = await page.screenshot({
      animations: 'disabled',
    });

    expect(image).toMatchImageSnapshot({
      customSnapshotsDir,
      customSnapshotIdentifier: context.id,
      diffDirection: 'vertical',
    });
  },
};
export default config;
```

```js:/test-runner-jest.config.js
import { getJestConfig } from "@storybook/test-runner";

/**
 * @type {import('@jest/types').Config.InitialOptions}
 */
export default {
  ...getJestConfig(),
  testEnvironmentOptions: {
    "jest-playwright": {
      connectOptions: {
        chromium: {
          wsEndpoint: "ws://127.0.0.1:3000",
        },
      },
    },
  },
};
```

# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã‚³ãƒãƒ³ãƒ‰ã²ã¨ã¤ã§ã¯ç„¡ç†ãªã®ã§ã€æ¬¡ã®ã‚ˆã†ãªã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã€‚

```sh:/bin/vrt.sh
#!/bin/sh

set -ex

PORT=6006

if [ ! -d storybook-static ]; then
  npm run build:storybook
fi

# refer: https://storybook.js.org/docs/writing-tests/test-runner
TEST_COMMAND="npx --yes wait-on tcp:${PORT} tcp:3000 && npm run test-storybook --url http://localhost:${PORT}"
# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãŸã„ã¨ã
if [ "$1" = "update" ]; then
  TEST_COMMAND="${TEST_COMMAND} --updateSnapshot"
fi

PLAYWRIGHT_VERSION=$(jq -r .devDependencies.playwright < package.json)

# refer: https://github.com/open-cli-tools/concurrently
npx concurrently \
    --kill-others \
    --success first \
    --names "SB,PW,TEST" \
    --prefix-colors "magenta,green,blue" \
    "npx --yes http-server storybook-static --port ${PORT} --silent" \
    "PLAYWRIGHT_VERSION=${PLAYWRIGHT_VERSION} docker compose up" \
    "${TEST_COMMAND}"
```

ã§ã€ npm scripts ã¨ã—ã¦æ¬¡ã‚’å®šç¾©ã™ã‚‹ã€‚

```json: package.json
  // snip
  "scripts": {
    "build:storybook": "storybook build",
    "test:storybook": "bin/vrt.sh",
    "test:storybook:update": "bin/vrt.sh update"
  },
  // snip
```

ã“ã‚Œã§ `npm run test:storybook` ã¨æ‰“ã¤ã¨ VRT ãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ `/__snapshots__` ã«ç”»åƒãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ `git commit` ã™ã‚‹ã€‚

# CI

GitHub Actions ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã€‚

```yaml:/.github/workflows/vrt.yaml
name: Visual Regression Testing

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - "/src/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/vrt.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_IAMGE_CACHE_PATH: /tmp/docker-image-cache
  PLAYWRIGHT_VERSION_PREFIX: v
  PLAYWRIGHT_VERSION_POSTFIX: -noble

jobs:
  visual-regression-testing:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache .turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: "npm"
          cache-dependency-path: package-lock.lock

      - name: Get Playwright version
        id: get_playwright_version
        run: |
          echo "PLAYWRIGHT_VERSION=${PLAYWRIGHT_VERSION_PREFIX}$(cat /package.json | jq --raw-output .devDependencies.playwright)${PLAYWRIGHT_VERSION_POSTFIX}" >> $GITHUB_ENV

      - name: Cache Docker images
        id: cache-docker-images
        uses: actions/cache@v4
        with:
          path: ${{ env.DOCKER_IAMGE_CACHE_PATH }}
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}

      - name: Pull and save Playwright Docker image
        if: steps.cache-docker-images.outputs.cache-hit != 'true'
        run: |
          docker pull mcr.microsoft.com/playwright:${PLAYWRIGHT_VERSION}
          docker save mcr.microsoft.com/playwright:${PLAYWRIGHT_VERSION} -o ${DOCKER_IAMGE_CACHE_PATH}

      - name: Load Docker image from cache
        run: docker load -i ${DOCKER_IAMGE_CACHE_PATH}

      - name: Install dependencies
        run: npm ci

      - name: Cache Storybook build
        id: cache-storybook-build
        uses: actions/cache@v4
        with:
          path: storybook-static
          key: ${{ runner.os }}-storybook-static-${{ github.sha }}

      - name: Build Storybook
        if: steps.cache-storybook-build.outputs.cache-hit != 'true'
        run: npm run build:storybook

      - name: Serve Storybook and run tests
        run: npm run test:vrt

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          path: /__snapshots__
```

ã“ã‚Œã§æ„å›³ã—ãªã„å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã€ CI ãŒæ¤œå‡ºã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
