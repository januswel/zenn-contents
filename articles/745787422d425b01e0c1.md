---
title: "unified ã‚’ä½¿ã£ã¦ Markdown ã‚’æ‹¡å¼µã™ã‚‹"
emoji: "ğŸ’ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [unified,JavaScript,TypeScript,Markdown,HTML]
published: true
---

unified ã®ä¸€ç•ªã®æ—¨å‘³ã§ã‚ã‚‹ã€æ–‡æ³•ã‚’æ‹¡å¼µã™ã‚‹æ–¹æ³•ã‚’æ›¸ãã¾ã™ã€‚ã¡ãªã¿ã«[ä»¥å‰ã®è¨˜äº‹](https://zenn.dev/januswel/articles/44801708e8c7fdd358e6)ã§ unified ã®ä½¿ã„æ–¹ã‚„ parser ãŠã‚ˆã³ compiler ã®ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã‚ã‹ã‚‰ãªã„è¨€è‘‰ãŒã‚ã‚‹å ´åˆã¯ [unified ã«ãŠã‘ã‚‹è¨€è‘‰ã®å®šç¾©ã‚’ã¾ã¨ã‚ãŸè¨˜äº‹](https://zenn.dev/januswel/articles/e4f979b875298e372070)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## transformer ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

unified ã§ã¯ transformer ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§æ§˜ã€…ãªã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»Šå›ã®ç›®çš„ã§ã‚ã‚‹ Markdown ã®æ‹¡å¼µã‚‚ transformer ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§å®Ÿç¾ã—ã¾ã™ã€‚

ä½•ã‚‚ã—ãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã¨ãªã‚Šã¾ã™ã€‚

```typescript:nop.ts
import unified from "unified";
import { Node } from "unist";
import { VFileCompatible } from "vfile";

const nop: unified.Plugin = () => {
  return (tree: Node, file: VFileCompatible) => {
    // nop
  };
};

export default nop;
```

è‡ªåˆ†ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œã‚‹å ´åˆã¯ `// nop` ã®ã‚³ãƒ¡ãƒ³ãƒˆã®éƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

## ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–‹ç™ºã«æœ‰ç”¨ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³

ç¾åœ¨ã® AST ã®çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹ print ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```typescript:print.ts
import unified from "unified";
import { Node } from "unist";
import { VFileCompatible } from "vfile";
import { inspect } from "unist-util-inspect";

const print: unified.Plugin = () => {
  return (tree: Node, file: VFileCompatible) => {
    console.log(inspect(tree));
  };
};

export default print;
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é–‹ç™ºã§ã¯ã€å¸¸ã« AST ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã£ã¦é©å®œæ°—ã«ãªã‚‹ã¨ã“ã‚ã‚’è¡¨ç¤ºã•ã›ã¾ã—ã‚‡ã†ã€‚

## transformer ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®é©ç”¨é †

ãªãŠã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®é©ç”¨é †åºã«ã¯æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

```typescript
const processor = unfied()
  .use(A)
  .use(print)
  .use(B)
```

`print` ã‚’å…ˆã»ã©ç´¹ä»‹ã—ãŸ print ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ã€ã“ã®ã‚ˆã†ã«é©ç”¨ã—ãŸå ´åˆã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ A ãŒé©ç”¨ã•ã‚ŒãŸç›´å¾Œã® AST ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

æ„å›³é€šã‚Šã®çµæœãŒå¾—ã‚‰ã‚Œãªã„ã¨ãã¯å„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†å†…å®¹ã‚’æ¯”è¼ƒã—ã€é †ç•ªãŒé–“é•ã£ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## Zenn ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã‚’è§£é‡ˆã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µã™ã‚‹

ã“ã“ã§ã¯ Zenn ã®ã‚ªãƒªã‚¸ãƒŠãƒ«è¨˜æ³•ã§ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã‚’å®Ÿç¾ã™ã‚‹ transformer ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### æ–¹é‡

Markdown ã‚’ HTML ã«å¤‰æ›ã™ã‚‹å ´åˆã€æ¬¡ã®å›³ã®æµã‚Œã‚’ãŸã©ã‚Šã¾ã™ã€‚

![å¤‰æ›ã®æµã‚Œ](https://storage.googleapis.com/zenn-user-upload/movb1yr8vmylht8k68womu62ftgm)

ä»Šå›ã¯æ¬¡ã®æ–¹é‡ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

1. mdast ã‚’è§£æã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã®éƒ¨åˆ†ã‚’ message ãƒãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹
2. mdast ã‹ã‚‰ hast ã¸å¤‰æ›ã™ã‚‹éš›ã€ message ãƒãƒ¼ãƒ‰ã‚’ `msg` class ã‚’æŒã¤ div ãƒãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹

### Zenn ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•

[Zenn å…¬å¼ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://zenn.dev/zenn/articles/markdown-guide#%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8)ã«ã‚ˆã‚‹ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¬¡ã®è¨˜æ³•ã§æ›¸ã‘ã‚‹ã‚ˆã†ã§ã™ã€‚

```
:::message
ã“ã‚Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™
:::
```

ã¾ãŸã€ã“ã‚Œã‚’ Zenn ã§è¡¨ç¤ºã•ã›ã‚‹ã¨ã€æ¬¡ã® HTML ã¨ãªã‚‹ã‚ˆã†ã§ã™ã€‚

```
<div class="msg">ã“ã‚Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™</div>
```

ã“ã®å¤‰æ›ãŒå¯èƒ½ã¨ãªã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### åŸºç¤ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰

ã¾ãš Markdown ã‹ã‚‰ HTML ã‚’ç”Ÿæˆã•ã›ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚

```typescript
import unified from "unified";
import parser from "remark-parse";
import toHast from "remark-rehype";
import compiler from "rehype-stringify";

const plugin: unified.Plugin = () => {
  return (tree: Node, _file: VFileCompatible) => {
    // ã“ã“ã‚’å®Ÿè£…ã—ã¦ã„ã
  }
}

const processor = unified()
  .use(parser)
  .use(plugin)
  .use(toHast)
  .use(compiler)

const data = `
:::message
ã“ã‚Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™
:::
`

console.log(processor.processSync(data).toString())
```

parser ã¯ Markdown ã‚’ mdast ã¸å¤‰æ›ã™ã‚‹ remark-parse ã€ transformer ã¯ mdast ã‚’ hast ã¸å¤‰æ›ã™ã‚‹ remark-rehype ã€ compiler ã¯ hast ã‚’ HTML ã¸å¤‰æ›ã™ã‚‹ rehype-stringify ã§ã™ã€‚

### mdast ã‚’ç¢ºèªã™ã‚‹

print ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ä»Šã® mdast ã‚’è¡¨ç¤ºã—ã¦ã¿ã¾ã™ã€‚

```
root[1] (1:1-5:1, 0-27)
â””â”€0 paragraph[1] (2:1-4:4, 1-26)
    â””â”€0 text ":::message\nã“ã‚Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™\n:::" (2:1-4:4, 1-26)
```

`paragraph` ãƒãƒ¼ãƒ‰ã®ç›´ä¸‹ã« `text` ãƒãƒ¼ãƒ‰ãŒã‚ã‚Šã€æ”¹è¡Œã‚‚å«ã‚ã¦ã²ã¨ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è§£é‡ˆã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‚’æ¢ã™

ã¾ãšã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã‚’æ¢ã™å‡¦ç†ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚

```typescript
import { isParent, isText, isParagraph } from "./util";

const MESSAGE_BEGGINING = ":::message\n";
const MESSAGE_ENDING = "\n:::";

function isMessage(node: unknown): node is Paragraph {
  if (!isParagraph(node)) {
    return false;
  }

  const { children } = node;

  const firstChild = children[0];
  if (!(isText(firstChild) && firstChild.value.startsWith(MESSAGE_BEGGINING))) {
    return false;
  }

  const lastChild = children[children.length - 1];
  if (!(isText(lastChild) && lastChild.value.endsWith(MESSAGE_ENDING))) {
    return false;
  }

  return true;
}
```

[`isParent` ã€ `isText` ã€ `isParagraph` ã®å®šç¾©ã¯ GitHub ã«ä¸Šã’ã¦ã„ã¾ã™](https://github.com/januswel/unified-sample/blob/main/src/plugins/transformers/util.ts)ã®ã§å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã“ã“ã§ã¯ãƒãƒ¼ãƒ‰ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤æ–­ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã® 3 ã¤ã‚’åˆ¤æ–­ã—ã¦ã„ã¾ã™ã€‚

1. `Paragraph` å‹ã§ã‚ã‚‹ãƒãƒ¼ãƒ‰ã§ã‚ã‚‹
2. å­ãƒãƒ¼ãƒ‰ã®ä¸€ç•ªæœ€åˆãŒãƒ†ã‚­ã‚¹ãƒˆã§ã‚ã‚Šã€ `:::message\n` ã§ã¯ã˜ã¾ã£ã¦ã„ã‚‹
3. å­ãƒãƒ¼ãƒ‰ã®ä¸€ç•ªæœ€å¾ŒãŒãƒ†ã‚­ã‚¹ãƒˆã§ã‚ã‚Šã€ `\n:::` ã§çµ‚ã‚ã£ã¦ã„ã‚‹

2 ç•ªã¨ 3 ç•ªã‚’ã¾ã¨ã‚ã¦ `/^:::message\n.*\n:::/` ã®ã‚ˆã†ãªæ­£è¦è¡¨ç¾ã§ãƒãƒƒãƒã§ããªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æ¬¡ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚’æ¸¡ã•ã‚ŒãŸå ´åˆã‚’æƒ³å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```markdown
:::message
ã“ã‚Œã¯**é‡è¦**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™
:::
```

ã“ã®æ–‡å­—åˆ—ã«å¯¾å¿œã™ã‚‹ mdast ã¯æ¬¡ã«ãªã‚Šã¾ã™ã€‚

```
root[1] (1:1-5:1, 0-33)
â””â”€0 paragraph[3] (2:1-4:4, 1-32)
    â”œâ”€0 text ":::message\nã“ã‚Œã¯" (2:1-3:4, 1-15)
    â”œâ”€1 strong[1] (3:4-3:10, 15-21)
    â”‚   â””â”€0 text "é‡è¦" (3:6-3:8, 17-19)
    â””â”€2 text "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™\n:::" (3:10-4:4, 21-32)
```

paragraph ã®å­ãƒãƒ¼ãƒ‰ã¯ã²ã¨ã¤ã¨ã¯é™ã‚‰ãªã„ã‚ã‘ã§ã™ã­ã€‚

ã•ã¦ã€å®šç¾©ã—ãŸ `isMessage` ã‚’ã©ã†ä½¿ã†ã‹ã§ã™ãŒã€ unist ã¯ [unist-util-visit](https://github.com/syntax-tree/unist-util-visit) ã¨ã„ã† Visitor ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```typescript
import unified from "unified";
import { Node, Parent } from "unist";
import { VFileCompatible } from "vfile";
import visit from "unist-util-visit";
import { Paragraph } from "mdast";
import { inspect } from "unist-util-inspect";

function visitor(
  node: Paragraph,
  index: number,
  parent: Parent | undefined
) {
  // ã“ã“ã«å¤‰æ›å‡¦ç†ã‚’æ›¸ã
}

const plugin: unified.Plugin = () => {
  return (tree: Node, _file: VFileCompatible) => {
    visit(tree, isMessage, visitor);
  };
};
```

ã“ã‚Œã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã®æŠ½å‡ºãŒã§ãã¾ã—ãŸã€‚

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜æ³•ã¨åˆ¤æ–­ã—ãŸç®‡æ‰€ã‚’ message ãƒãƒ¼ãƒ‰ã¸å¤‰æ›ã™ã‚‹

æ¬¡ã¯å¤‰æ›å‡¦ç†ã§ã™ã€‚å…ˆã»ã©ã® `visitor` é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```typescript
function processFirstChild(children: Array<Node>, identifier: string) {
  const firstChild = children[0];
  const firstValue = firstChild.value as string;
  if (firstValue === identifier) {
    children.shift();
  } else {
    children[0] = {
      ...firstChild,
      value: firstValue.slice(identifier.length),
    };
  }
}

function processLastChild(children: Array<Node>, identifier: string) {
  const lastIndex = children.length - 1;
  const lastChild = children[lastIndex];
  const lastValue = lastChild.value as string;
  if (lastValue === identifier) {
    children.pop();
  } else {
    children[lastIndex] = {
      ...lastChild,
      value: lastValue.slice(0, lastValue.length - identifier.length),
    };
  }
}

function visitor(node: Paragraph, index: number, parent: Parent | undefined) {
  if (!isParent(parent)) {
    return;
  }

  const children = [...node.children];
  processFirstChild(children, MESSAGE_BEGGINING);
  processLastChild(children, MESSAGE_ENDING);

  parent.children[index] = {
    type: "message",
    children,
  };
}
```

`processFirstChild` ã¨ `processLastChild` ã«ã¤ã„ã¦ã¯ã€ãã®ã¾ã¾å¿…è¦ãªå‡¦ç†ã‚’æ›¸ãä¸‹ã—ã¦ã„ã¾ã™ã€‚

[ãƒãƒ¼ãƒ‰ã®ç½®ãæ›ãˆã‚’ã™ã‚‹å ´åˆã¯ã€ `parent.children` ã‚’æ“ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹](https://github.com/syntax-tree/unist-util-visit-parents#next--visitornode-ancestors)ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã•ã¦ã€ã“ã‚Œã§ message ãƒãƒ¼ãƒ‰ã¸ã®å¤‰æ›ã¯çµ‚ã‚ã‚Šã§ã™ã€‚

### message ãƒãƒ¼ãƒ‰ã‹ã‚‰ `msg` class ã‚’æŒã¤ div ãƒãƒ¼ãƒ‰ã¸å¤‰æ›ã™ã‚‹

mdast ã‹ã‚‰ hast ã¸ã®å¤‰æ›å‡¦ç†ã‚’æ‹¡å¼µã—ã¾ã™ã€‚

remark-rehype ã¯ç¬¬äºŒå¼•æ•°ã« `handlers` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚ã“ã‚ŒãŒ mdast ã®ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚

```typescript
import { H } from "mdast-util-to-hast";

export default function handler(h: H, node: Node) {
  // ã“ã“ã‚’å®Ÿè£…ã™ã‚‹
}

const processor = unified()
  .use(parser)
  .use(plugin)
  .use(toHast, {
    handlers: {
      message: handler,
    },
  })
  .use(compiler);
```

ã“ã‚Œã§ã‚ã¨ã¯ `handler` é–¢æ•°ã®ä¸­èº«ã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã§ã™ã€‚ [hast ã®ãƒãƒ¼ãƒ‰ã®æ§‹é€ ](https://github.com/syntax-tree/hast#element)ã«æ²¿ã£ã¦ã€æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã—ã‚‡ã†ã€‚

```typescript
import all from "./all";

export default function handler(h: H, node: Node) {
  return {
    type: "element",
    tagName: "div",
    properties: {
      className: ["msg"],
    },
    children: all(h, node),
  };
}
```

[`all` é–¢æ•°ã¯ mdast-util-to-hast ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼é–¢æ•°](https://github.com/syntax-tree/mdast-util-to-hast/blob/main/lib/all.js)ã§ã™ã€‚

ã“ã‚Œã§å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚

## ã¾ã¨ã‚

ä»Šå›ç´¹ä»‹ã—ãŸæ–¹æ³•ã¯ unist ã§ AST ã‚’æ“ä½œã™ã‚‹ã«ã‚ãŸã£ã¦ã®åŸºç¤ã¨ãªã‚‹å†…å®¹ã§ã™ãŒã€éå¸¸ã«å¿œç”¨ãŒåŠ¹ãæ–¹æ³•ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚ Markdown ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸ DSL ãªã©ã€ãœã²ãŠå¥½ã¿ã®è¨€èªã‚’ç”Ÿã¿å‡ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚

å®Ÿè£…ã«ã‚ãŸã£ã¦ã¯ [AMDX](https://github.com/mizchi/amdx) ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒéå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‚‚èª­ã‚“ã§ã¿ã‚‹ã¨ã€ã‚ˆã‚Š unified ã«ã¤ã„ã¦ã®ç†è§£ãŒé€²ã‚€ã§ã—ã‚‡ã†ã€‚
