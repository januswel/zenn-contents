---
title: "Apollo Server + Prisma ã‚’ AWS CDK ã§ AWS Lambda ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["apollo", "apolloserver", "awscdk", "awslambda", "graphql"]
published: true
---

Apollo Server + Prisma ã¯å‰²ã‚Šã¨é‰„æ¿ãªã‚“ã˜ã‚ƒãªã‹ã‚ã†ã‹ã€‚

ã“ã‚Œã‚’ AWS ä¸Šã§ã‚³ã‚¹ãƒˆä½ãä½¿ã„ãŸã„å ´åˆã¯ Lambda ã«è¼‰ã›ã‚‹ã¨ã„ã†é¸æŠè‚¢ã«ãªã‚‹ã ã‚ã†ã€‚[ãã‚Œ](https://www.apollographql.com/docs/apollo-server/deployment/lambda/)[ãã‚Œ](https://www.prisma.io/docs/guides/deployment/deployment-guides/deploying-to-aws-lambda)ã§ Lambda ã¸ã®è¼‰ã›æ–¹ã¯æ›¸ã„ã¦ãã‚Œã¦ã„ã‚‹ãŒã€å¾®å¦™ã«ã»ã—ã„æƒ…å ±ã¨ã‚ºãƒ¬ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã«ã¾ã¨ã‚ã‚‹ã€‚

## æ§‹æˆ

![æ§‹æˆå›³](/images/deployment-apollo-server-with-cdk/component-placement.png)

é–‹ç™ºã‚„äº‹æ¥­ã«é›†ä¸­ã—ãŸã„ãŸã‚ã€ API Gateway + Lambda ã®åŸºæœ¬æ§‹æˆã«åŠ ãˆ Aurora Serverless ã‚’ä½¿ã£ã¦å¯ç”¨æ€§ã‚’è¿½æ±‚ã—ã¦ã„ãã€‚ Aurora ã«ã¤ãªããŸã‚ Lambda ã¯ VPC å†…ã«ä½œã£ã¦ã„ã‚‹ã€‚ç‰¹ã«å¤–ã«å‡ºã¦ã„ãå¿…è¦ãŒãªã„ã®ã§ VPC ã‚µãƒ–ãƒãƒƒãƒˆã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã®ã¿ã€‚ Aurora ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ Secrets Manager ã«ä¿å­˜ã—ã€ä¸€å®šæœŸé–“ã§ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ã€‚ Lambda ã¯ Secrets Manager ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–ã‚Šå‡ºã— Aurora ã¸ã¤ãªãã«ã„ãã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã«ã¯ EC2 ã‚’ãŸã¦ã¦ [SSM Session Manager çµŒç”±ã§ SSH Port Forwarding](https://dev.classmethod.jp/articles/aws-ssm-support-remote-host-port-forward/) ã—ã€ç›´æ¥ã¤ãªãã«ã„ãã€‚

## ã§ãã¦ã„ã‚‹ã‚‚ã®

æ¬¡ã«ã‚³ãƒ¼ãƒ‰ã‚’ãŠã„ã¦ã„ã‚‹ã€‚

https://github.com/januswel/graphql-sample/tree/main/packages/infra

## è§£èª¬ã¨ã‹

### å¤§æ 

å¤§æ ã®æ§‹æˆã¨ã—ã¦å‚è€ƒã«ã—ãŸã®ã¯æ¬¡ã€‚

https://dev.classmethod.jp/articles/aws-cdk-connect-to-amazon-aurora-db-cluster-from-lambda-function-via-rds-proxy/

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚ã“ã“ã‹ã‚‰è¦ã‚‰ãªã„ã‚‚ã®ã‚’å‰Šã£ã¦ã„ã£ãŸã€‚

### Prisma

Prisma ã‚’ Lambda ã«è¼‰ã›ã‚‹éš›ã¯ã‚³ãƒ„ãŒã„ã‚‹ã€‚

https://dev.classmethod.jp/articles/aws-cdk-nodejsfunction-prisma-deploy/

å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ Serverless Framework ã§ã®ã‚„ã‚Šæ–¹ãŒè¼‰ã£ã¦ã„ã‚‹ã‚‚ã®ã®ã€ CDK ã§åŒæ§˜ã®ã“ã¨ã‚’ã‚„ã‚‹å ´åˆã¯ä¸Šã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚‹ã€‚

ã¾ãŸã€ Prisma ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ç’°å¢ƒå¤‰æ•°çµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šæƒ…å ±ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã—ã‹è¼‰ã£ã¦ãŠã‚‰ãšã€å‹•çš„ã«æ¥ç¶šå…ˆãŒå¤‰ã‚ã‚‹å ´åˆã«ã©ã†ã™ã‚Œã°ã„ã„ã‹é€”æ–¹ã«ãã‚Œã¦ã„ãŸã¨ãã€æ¬¡ã®è¨˜äº‹ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆæ™‚ã«æ¥ç¶šæƒ…å ±ã‚’æ¸¡ã›ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§éå¸¸ã«åŠ©ã‹ã£ãŸã€‚

https://zenn.dev/taroman_zenn/articles/da11f27537c37d#aws-%E3%81%A7%E3%82%82%E5%88%A9%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB-prismaclient-%E3%81%AE%E5%8F%96%E5%BE%97%E5%87%A6%E7%90%86%E3%81%AE%E5%AE%9F%E8%A3%85

### Apollo Server

GraphQL schema ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ãŸã‚ã«ã€ Prisma ã¨åŒæ§˜ã€ `NodejsFunction` ã® `bundling.commandHooks` ã‚’ä½¿ã†ã€‚

æœ¬å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹å‰ã« Secrets Manager ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ Apollo Server ãŒæä¾›ã™ã‚‹ handler ä½œæˆé–¢æ•°ã¯ãã†ã„ã£ãŸå‡¦ç†ã‚’å·®ã—æŒŸã‚€ã‚¹ã‚­ãƒãŒãªã„ã€‚

ä»•æ–¹ãªã„ã®ã§ã€ä½œã£ã¦ã‚‚ã‚‰ã£ãŸ handler ã‚’è‡ªåˆ†ã§å‘¼ã³å‡ºã™ handler ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã€‚

```typescript
export const handler = async (event: any, context: any, callback: any) => {
  const secret = await getSecret();
  const databaseUrl = `postgresql://${secret.username}:${secret.password}@${secret.host}:${secret.port}/${DATABASE_NAME}?schema=${DATABASE_SCHEMA}`;

  const server = serverFactory(databaseUrl);
  const serverHandler = startServerAndCreateLambdaHandler(
    server,
    handlers.createAPIGatewayProxyEventRequestHandler()
  );

  return serverHandler(event, context, callback);
};
```

ã‚‚ã†ã²ã¨ã¤æ³¨æ„ç‚¹ã€‚å…¬å¼ã§ä¾‹ã«ã‚ãŒã£ã¦ã„ã‚‹ `createAPIGatewayProxyEventRequestHandlerV2` ã¯ API Gateway ã§ HTTP API ã‚’é¸æŠã—ãŸéš›ã«ä½¿ã†ã‚‚ã®ã®ã‚ˆã†ã ã€‚ REST API ã‚’ä½¿ã†å ´åˆã¯ `V2` ãŒãªã„ã‚‚ã®ã‚’æŒ‡å®šã™ã‚‹ã€‚

### è¸ã¿å°

è¸ã¿å°æ§‹ç¯‰ã¯åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯ã¨ã—ã¦åˆ†ã‘ãŸã»ã†ãŒå¿…è¦ãªã¨ãã®ã¿è¸ã¿å°ã‚’ãŸã¦ã¦ã€çµ‚ã‚ã£ãŸã‚‰å³ç ´æ£„ãŒã§ãã‚‹ã€‚ã“ã®å ´åˆã€ CDK ã®ã‚¯ãƒ­ã‚¹ã‚¹ã‚¿ãƒƒã‚¯é–“å‚ç…§ãŒå¿…è¦ã«ãªã‚‹ã€‚

ã“ã®ã¨ãå„ä»‹ãªã®ãŒã€å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãŸã‚ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆã›ãªããªã‚‹äº‹è±¡ã§ã€æ¬¡ã§å¯¾å‡¦æ³•ã¨ã¨ã‚‚ã«è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã€‚

https://dev.classmethod.jp/articles/aws-cdk-props-cross-stack-reference-problem-and-handle/

ã¾ãŸã€ SSH ã§ã¤ãªããŸã‚ã« ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä¸ãˆã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ CDK ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®è¨­å®šã²ã¨ã¤ã§ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚

https://dev.classmethod.jp/articles/aws-cdk-ssmsessionpermissions/
