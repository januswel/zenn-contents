---
title: "Chrome Extension ã‚’å††æ»‘ã«ä½œã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸª¤"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [JavaScript,chromeextension]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯ Manifest V3 ã‚’å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã€‚
:::

Chrome Extension ã‚’ä½œã£ãŸéš›ã«ã„ãã¤ã‹ãƒãƒã£ãŸã“ã¨ãŒã‚ã£ãŸã®ã§ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

https://chrome.google.com/webstore/detail/url-canonicalizer/kifnlgpidelbjfmcekcpfafaakjflgil?hl=ja

## ãƒšãƒ¼ã‚¸ä¸Šã§ã® JavaScript å®Ÿè¡Œçµæœã‚’å–å¾—ã™ã‚‹

[`scripting.executeScript`](https://developer.chrome.com/docs/extensions/reference/scripting/#handling-results) ã‚’ä½¿ã†ã®ã§ã™ãŒã€é–¢æ•°ã‚’æŒ‡å®šã™ã‚‹å½¢å¼ã®ã¿ã—ã‹å€¤ãŒè¿”ã£ã¦ãã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹å½¢å¼ã¨åŒã˜ãƒšãƒ¼ã‚¸ã«æ›¸ã‹ã‚Œã¦ãŠã‚Šã€åˆ¶é™ãŒæ˜ç¢ºã«æ›¸ã‹ã‚Œã¦ã„ãªã„ãŸã‚ç´›ã‚‰ã‚ã—ã„ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

### NG

æ¬¡ã¯å®Ÿè¡ŒçµæœãŒ `null` ã¨ã—ã¦è¿”ã£ã¦ãã¾ã™ã€‚

```javascript:injection.js
function getTitle() {
  return document.title;
}

// returns null
getTitle();

// same result
// (() => getTitle())();
```

```javascript:background.js
async function walkDocumentTitle() {
  const tabId = getTabId();
  const injectionResults = await chrome.scripting.executeScript({
    target: { tabId },
    files: ["injection.js"],
  });

  for (const frameResult of injectionResults)
    console.log('Frame Title: ' + frameResult.result);
  }
}

walkDocumentTitle();
```

### OK

æ¬¡ã¯æ„å›³é€šã‚Šã«å‹•ãã¾ã™ã€‚

```javascript:background.js
function getTitle() {
  return document.title;
}

async function walkDocumentTitle() {
  // snip

  const injectionResults = await chrome.scripting.executeScript({
    target: { tabId },
    func: getTitle,
  });

  // snip
}

walkDocumentTitle();
```

## ãƒšãƒ¼ã‚¸ä¸Šã§å®Ÿè¡Œã™ã‚‹é–¢æ•°ã¯æ–‡è„ˆãŒæ¬ è½ã™ã‚‹

é–¢æ•°ã‚’ãƒšãƒ¼ã‚¸ã¸ inject ã™ã‚‹ãŸã‚ã«ã€ Google Chrome ã¯é–¢æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¾ã™ã€‚ãã®ãŸã‚ã€ã¾ã‚ã‚Šã®æ–‡è„ˆã¨åˆ‡ã‚Šé›¢ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«é­é‡ã™ã‚‹ã¨ä½•æ•…ã‹ã‚ã‹ã‚‰ãšæ™‚é–“ã‚’ä½¿ã£ã¦ã—ã¾ã†ã®ã§çªèµ·ã—ã¾ã™ã€‚

> This function will be serialized, and then deserialized for injection. This means that any bound parameters and execution context will be lost.

https://developer.chrome.com/docs/extensions/reference/scripting/#type-ScriptInjection

### NG

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ `isHtmlLinkElement` ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

```javascript
function isHTMLLinkElement(el) {
  return "href" in el;
}

function getCanonicalUrl() {
  const canonical = document.querySelector('link[rel="canonical"]');
  if (
    canonical === null ||
    !isHTMLLinkElement(canonical) ||
    canonical.href === undefined
  ) {
    throw new Error("canonical URL is unspecified");
  }
  return canonical.href;
}

chrome.scripting.executeScript({
  const tabId = getTabId();
  const injectionResults = await chrome.scripting.executeScript({
    target: { tabId },
    func: getCanonicalUrl,
  });

  // snip
})
```

### OK

ã„ãã¤ã‹å¯¾å‡¦æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€ç•ªç¢ºå®Ÿãªã‚‚ã®ã¯ inject ã—ãŸã„ã‚³ãƒ¼ãƒ‰ã‚’ã²ã¨ã¤ã®é–¢æ•°ã«ã¾ã¨ã‚ã¦ã—ã¾ã†æ–¹æ³•ã§ã™ã€‚

```javascript
function injectedCodes() {
  function isHTMLLinkElement(el) {
    return "href" in el;
  }

  function getCanonicalUrl() {
    const canonical = document.querySelector('link[rel="canonical"]');
    if (
      canonical === null ||
      !isHTMLLinkElement(canonical) ||
      canonical.href === undefined
    ) {
      throw new Error("canonical URL is unspecified");
    }
    return canonical.href;
  }

  return getCanonicalUrl()
}

chrome.scripting.executeScript({
  const tabId = getTabId();
  const injectionResults = await chrome.scripting.executeScript({
    target: { tabId },
    func: injectedCodes,
  });

  // snip
})
```

`isHTMLLinkElement` ã®ã‚ˆã†ãªç°¡å˜ãªé–¢æ•°ã‚’å†…éƒ¨ã§ä½¿ã„ãŸã„ã ã‘ã§ã‚ã‚Œã° webpack ã§ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹éš›ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚‹ã¨ã„ã†æ–¹æ³•ãŒä½¿ãˆã¾ã™ã€‚ `mode` ã‚’ `production` ã¨ã—ã¦ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã¨ã€ webpack ã¯æœ€é©åŒ–ã‚’ã‹ã‘ã¦ãã‚Œã¾ã™ã€‚ãã®éš›ã«å†…éƒ¨ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ [terser ã«ãŠã„ã¦ã€ç°¡å˜ãªé–¢æ•°ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã—ã¦ãã‚Œã‚‹](https://github.com/terser/terser#compress-options)ã‚ˆã†ã§ã™ã€‚

ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹å½¢å¼ã§ã® `executeScript` å‘¼ã³å‡ºã—ãŒè¨±ã•ã‚Œã‚‹çŠ¶æ³ã§ã‚ã‚Œã°ã€åŒæ§˜ã« webpack ã‚’ä½¿ã£ã¦ã²ã¨ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã“ã¨ã§ã“ã®åˆ¶é™ã‚’å›é¿ã§ãã¾ã™ã€‚[è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ãŸã„å ´åˆã¯ entry ã« Object ã‚’æŒ‡å®šã™ã‚‹å½¢å¼](https://webpack.js.org/concepts/entry-points/#object-syntax)ãŒä½¿ãˆã¾ã™ã€‚

## `host_permission` ã‚’æŒ‡å®šã™ã‚‹ä»£ã‚ã‚Šã« `activeTab` ã‚’ä½¿ãˆãªã„ã‹æ¤œè¨ã™ã‚‹

manifest.json ã«æ›¸ã permission ã¨ã—ã¦ `<all_urls>` ã¯å¼·ã™ãã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ä¸Šã§å‹•ã‹ã™ã ã‘ã§è‰¯ã‘ã‚Œã° `activeTab` ã‚’æŒ‡å®šã—ã¾ã™ã€‚

https://developer.chrome.com/docs/extensions/mv3/manifest/activeTab/

> This serves as an alternative for many uses of &gt;all_urls>, but displays no warning message during installation
