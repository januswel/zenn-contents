---
title: "LINE ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã® React Native Native Module ã‚’ä½œã‚‹"
emoji: "ğŸŒ±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [reactnative, line]
published: true
---

ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ¬¡ã€‚

https://github.com/januswel/LineLoginSample

# å‹•æ©Ÿ

Firebase ã§ LINE ãƒ­ã‚°ã‚¤ãƒ³çµŒç”±ã®èªè¨¼ã‚’å®Ÿç¾ã—ãŸã„å ´åˆã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ `react-native-app-auth` ã‚’ä½¿ã†ã¯ãšã ã€‚ã—ã‹ã—ã€ iOS ã ã¨ã€Œ[ã‚µã‚¤ãƒˆè¶Šãˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’é˜²ã](https://support.apple.com/ja-jp/guide/iphone/iphb01fc3c85/17.0/ios/17.0)ã€è¨­å®šã®ãŸã‚ã«ã†ã¾ãã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å¼•ãç¶™ã’ãªã„ã€‚

https://rnfirebase.io/auth/oidc-auth

ãŸã ã— iOS / Android ã¨ã‚‚ã« LINE ç¤¾ã¯ SDK ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã‚‹ã€‚ãã“ã§ Native Module ã¨ã—ã¦ LINE ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè£…ã—ã€ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’å¾—ã¦ Firebase ã¸é€£æºã™ã‚‹æ–¹æ³•ã§å®Ÿç¾ã™ã‚‹ã€‚

# æ–¹é‡

OpenID Connect ã‚’ç”¨ã„ã¦å®Ÿè£…ã™ã‚‹ã€‚ LINE å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è©³ã—ãæ›¸ã„ã¦ã‚ã‚‹ã€‚

https://developers.line.biz/ja/docs/line-login/secure-login-process/#using-openid-to-register-new-users

ã‚¹ã‚³ãƒ¼ãƒ—æŒ‡å®šã¯ `openid` ã¨ `profile` ã€ `email` ã§å›ºå®šã—ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã€‚å®Ÿéš›ã«æ¬²ã—ã„ç‰©ãŒè¶³ã‚Šãªã„å ´åˆã¯é©å®œè¿½åŠ ã™ã‚‹ã¨è‰¯ã„ã ã‚ã†ã€‚

ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã«ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã« `nonce` ã‚’æŒ‡å®šã™ã‚‹è¨­è¨ˆã¨ã—ã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯ã‚µãƒ¼ãƒãƒ¼ã§ç”Ÿæˆã—ãŸã‚‚ã®ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ‰•ã„å‡ºã—ã¦æŒ‡å®šã™ã‚‹ã¨è‰¯ã„ã€‚

LINE ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒ³ãƒãƒ«ã® ID ã¯ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æŒ‡å®šã™ã‚‹ã€‚ãƒã‚¤ãƒ†ã‚£ãƒ–å±¤ã§ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã—ãŸã„ã®ã§ã€ä½¿ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ [react-native-config](https://github.com/luggit/react-native-config) ä¸€æŠã€‚

React Native å…¬å¼ã® Native Module å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã‚’ã‚‚ã¨ã«ä½œæ¥­ã™ã‚‹ã€‚

https://reactnative.dev/docs/native-modules-intro

# å®Ÿè£…

## Android

Kotlin ã‚’ä½¿ã†ã®ã§ã€äº‹å‰ã«[è¨­å®š](https://zenn.dev/beingish/articles/d579adc48795ab)ã‚’ã—ã¦ãŠãã“ã¨ã€‚

åŸºæœ¬çš„ãªæµã‚Œã¯æ¬¡ã¨ãªã‚‹ã€‚

1. è¨­å®š
2. æ©Ÿèƒ½å®Ÿè£…
3. 1 ç•ªã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ã¾ã¨ã‚ã‚‹
4. MainApplication.java ã‹ã‚‰ 2 ç•ªã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‘¼ã³å‡ºã™

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¯ `com.example.line` ã¨ã™ã‚‹ã€‚

### è¨­å®š

LINE SDK ã®åˆ¶ç´„ã§ã€ `minSdkVersion` ã¯ 24 ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

```groovy:android/build.gradle
        minSdkVersion = 24
```

Java 1.8 ã®ã‚µãƒãƒ¼ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚

```groovy:android/app/build.gradle
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
```

LINE SDK ã®ä¾å­˜ã‚’è¿½åŠ ã™ã‚‹ã€‚

```groovy:android/app/build.gradle
    implementation("com.linecorp.linesdk:linesdk:latest.release")
```

### æ©Ÿèƒ½å®Ÿè£…

[LINE å…¬å¼ã®ã‚¬ã‚¤ãƒ‰ã ã¨ Java ã§ã®å®Ÿè£…](https://developers.line.biz/ja/docs/line-login-sdks/android-sdk/integrate-line-login/#starting-login-activity)ãªã®ã§ã€ã“ã“ã«ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚’ç´¹ä»‹ã™ã‚‹ã€‚

```kotlin:android/app/src/main/java/com/example/line/LineLoginModule.kt
package com.example.line

import android.app.Activity
import android.content.Intent
import android.util.Log
import com.facebook.react.bridge.*
import com.linecorp.linesdk.LineApiResponseCode.*
import com.linecorp.linesdk.Scope
import com.linecorp.linesdk.api.LineApiClient
import com.linecorp.linesdk.api.LineApiClientBuilder
import com.linecorp.linesdk.auth.LineAuthenticationParams
import com.linecorp.linesdk.auth.LineLoginApi
import java.util.Arrays

class LineLoginModule(reactContext: ReactApplicationContext, lineChannelId: String) :
    ReactContextBaseJavaModule(reactContext) {
  override fun getName() = "LineLogin"

  private var loginPromise: Promise? = null

  private val reactContext: ReactApplicationContext = reactContext
  private val lineChannelId: String = lineChannelId

  init {
    val activityEventListener: BaseActivityEventListener =
        object : BaseActivityEventListener() {
          override fun onActivityResult(
              activity: Activity?,
              requestCode: Int,
              resultCode: Int,
              intent: Intent?
          ) {
            if (requestCode != REQUEST_CODE) {
              loginPromise?.let { promise ->
                promise.reject(E_FAILED_TO_LOGIN, "Unsupported Request Code: " + requestCode)
              }
              return
            }

            val result = LineLoginApi.getLoginResultFromIntent(intent)

            loginPromise?.let { promise ->
              when (result.getResponseCode()) {
                SUCCESS -> {
                  val ret = Arguments.createMap()
                  ret.putString("displayName", result.lineProfile?.displayName)
                  ret.putString("pictureUrl", result.lineProfile?.pictureUrl.toString())
                  ret.putString("email", result.lineIdToken?.email)
                  ret.putString("idToken", result.lineIdToken?.rawString)
                  promise.resolve(ret)
                }
                CANCEL -> {
                  promise.reject(E_LOGIN_CANCELED, "LINE Login canceled by user")
                }
                else -> {
                  promise.reject(E_FAILED_TO_LOGIN, result.errorData.message)
                }
              }

              loginPromise = null
            }
          }
        }

    reactContext.addActivityEventListener(activityEventListener)

    val apiClientBuilder = LineApiClientBuilder(reactContext, lineChannelId)
    lineApiClient = apiClientBuilder.build()
  }

  @ReactMethod
  fun login(nonce: String, promise: Promise) {
    val activity = currentActivity

    if (activity == null) {
      promise.reject(E_ACTIVITY_DOES_NOT_EXIST, "Activity doesn't exist")
      return
    }

    loginPromise = promise

    try {
      val loginIntent =
          LineLoginApi.getLoginIntent(
              reactContext,
              lineChannelId,
              LineAuthenticationParams.Builder()
                  .scopes(Arrays.asList(Scope.PROFILE, Scope.OPENID_CONNECT, Scope.OC_EMAIL))
                  .nonce(nonce)
                  .build()
          )
      activity.startActivityForResult(loginIntent, REQUEST_CODE)
    } catch (t: Throwable) {
      Log.e("ERROR", t.toString())
      loginPromise?.reject(E_FAILED_TO_LOGIN, t)
      loginPromise = null
    }
  }

  @ReactMethod
  fun logout(dummy: Srring, promise: Promise) {
    lineApiClient?.let { client ->
      val response = client.logout()

      if (response.isSuccess()) {
        promise.resolve(null)
        return
      }

      promise.reject(E_FAILED_TO_LOGOUT, response.errorData.message)
      return
    }

    // not reachable
    throw Exception("LineApiClient is not initialized")
  }

  companion object {
    const val REQUEST_CODE = 1
    const val E_ACTIVITY_DOES_NOT_EXIST = "E_ACTIVITY_DOES_NOT_EXIST"
    const val E_LOGIN_CANCELED = "E_LOGIN_CANCELED"
    const val E_FAILED_TO_LOGIN = "E_FAILED_TO_LOGIN"
    const val E_FAILED_TO_LOGOUT = "E_FAILED_TO_LOGOUT"

    var lineApiClient: LineApiClient? = null
  }
}
```

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã€ OpenID Connect çµŒç”±ã®æƒ…å ±ã¯ `lineIdToken` ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã€‚ã“ã‚Œã¯ JWT ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã ã€‚

### æ©Ÿèƒ½ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ã¾ã¨ã‚ã‚‹

Native Module ã¯ `ReactPackage` ã‚’ç¶™æ‰¿ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã®ã§ã€ãã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹ã€‚

```kotlin:android/app/src/main/java/com/example/line/LineLoginPackage.kt
package com.example.line

import android.view.View
import com.facebook.react.ReactPackage
import com.facebook.react.bridge.NativeModule
import com.facebook.react.bridge.ReactApplicationContext
import com.facebook.react.uimanager.ReactShadowNode
import com.facebook.react.uimanager.ViewManager

class LineLoginPackage(lineChannelId: String) : ReactPackage {
  private val lineChannelId: String = lineChannelId

  override fun createViewManagers(
      reactContext: ReactApplicationContext
  ): MutableList<ViewManager<View, ReactShadowNode<*>>> = mutableListOf()

  override fun createNativeModules(
      reactContext: ReactApplicationContext
  ): MutableList<NativeModule> =
      listOf(LineLoginModule(reactContext, lineChannelId)).toMutableList()
}
```

`createViewManagers` ã€ `createNativeModules` ã‚’å®Ÿè£…ã—ã¦ã‚„ã‚Œã°è‰¯ã„ã ã‘ãªã®ã§ã“ã“ã¯ãŠä½œæ³•ã¨ã—ã¦è¦šãˆã¦ã—ã¾ã†ã¨è‰¯ã„ã€‚

### MainApplication.java ã‹ã‚‰ä½œã£ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‘¼ã³å‡ºã™

```java
    @Override
    protected List<ReactPackage> getPackages() {
      @SuppressWarnings("UnnecessaryLocalVariable")
      List<ReactPackage> packages = new PackageList(this).getPackages();
      packages.add(new LineLoginPackage(BuildConfig.LINE_CHANNEL_ID));
      return packages;
    }
```

`getPackages` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ä½œæˆã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã€ `packages.add` ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã€‚

## iOS

React Native å´ãŒ Objective-C ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ LINE SDK ã¯ Objective-C ã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸã‚‚ã®ã‚’ä½¿ã†ã€‚

https://developers.line.biz/ja/docs/line-login-sdks/ios-sdk/swift/using-objc/#use-wrapper

1. è¨­å®š
2. æ©Ÿèƒ½å®Ÿè£…

### è¨­å®š

LINE SDK ã®ä¾å­˜ã‚’è¿½åŠ ã™ã‚‹ã€‚

```ruby:Podfile
target 'LineLoginSample' do
    pod 'LineSDKSwift/ObjC', '~> 5.0'
end
```

è¨­å®šã‚’æ›¸ã„ãŸã‚ã¨ã« `(cd ios; pod install)` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

LINE ã‹ã‚‰ã‚¢ãƒ—ãƒªã«ã€ã‚¢ãƒ—ãƒªã‹ã‚‰ LINE ã«ç§»å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ãã®ãŸã‚ã®è¨­å®šã‚’ã™ã‚‹ã€‚

```xml:ios/Info.plist
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <!-- LINEã‹ã‚‰ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹éš›ã«åˆ©ç”¨ã™ã‚‹URLã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ  -->
            <string>line3rdp.$(PRODUCT_BUNDLE_IDENTIFIER)</string>
        </array>
    </dict>
</array>
<key>LSApplicationQueriesSchemes</key>
<array>
    <!-- ã‚¢ãƒ—ãƒªã‹ã‚‰LINEã‚’èµ·å‹•ã™ã‚‹éš›ã«åˆ©ç”¨ã™ã‚‹URLã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ  -->
    <string>lineauth2</string>
</array>
```

```objc:ios/LineLoginSample/AppDelegate.m
@import LineSDK;

// snip

- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary<UIApplicationOpenURLOptionsKey,id> *)options {
  return [[LineSDKLoginManager sharedManager] application:app open:url options:options];
}
```

ã¾ãŸã€ AppDelegate.mm ã¯ Objective-C++ ã§ã‚ã‚Šã€ `@import` ãŒä½¿ãˆãªã„ãŸã‚ã€æ‹¡å¼µå­ã‚’ `.m` ã«å¤‰æ›´ã—ã¦ãŠãã€‚

### æ©Ÿèƒ½å®Ÿè£…

ãƒ˜ãƒƒãƒ€ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ã€ `RCTBridgeModule` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã€‚

```objc:ios/LineLogin/LineLogin.h
#ifndef LineLogin_h
#define LineLogin_h

#import <React/RCTBridgeModule.h>

@interface MBTLineLogin : NSObject <RCTBridgeModule>

+(void)initialize;

@end

#endif /* LineLogin_h */
```

å®Ÿè£…ã¯æ¬¡ã®ã‚ˆã†ã«ã€‚

```objc:ios/LineLogin/LineLogin.m
#import <UIKit/UIKit.h>
#import <React/RCTLog.h>
#import "AppDelegate.h"
#import "RNCConfig.h"
#import "LineLogin.h"
@import LineSDK;

@implementation MBTLineLogin

// https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize
+ (void)initialize {
  if (self == [MBTLineLogin self]) {
    NSString *lineChannelId = [RNCConfig envFor:@"LINE_CHANNEL_ID"];
    RCTLogInfo(@"LINE channel ID: %@", lineChannelId);
    [[LineSDKLoginManager sharedManager] setupWithChannelID:lineChannelId universalLinkURL:nil];
  }
}

RCT_EXPORT_MODULE(LineLogin);

RCT_EXPORT_METHOD(login: (NSString *)nonce
                  resolver:(RCTPromiseResolveBlock)resolve
                  refector:(RCTPromiseRejectBlock)reject)
{
  RCTLogInfo(@"Trying LINE login");

  NSSet *permissions = [NSSet setWithObjects:
                        [LineSDKLoginPermission profile],
                        [LineSDKLoginPermission email],
                        [LineSDKLoginPermission openID],
                        nil];

  LineSDKLoginManagerParameters *parameters = [[LineSDKLoginManagerParameters new] init];
  parameters.IDTokenNonce = nonce;

  // appDelegate and rootViewController must be used in main thread
  dispatch_async(dispatch_get_main_queue(), ^{
    AppDelegate *delegate = (AppDelegate *)[[UIApplication sharedApplication] delegate];

    [[LineSDKLoginManager sharedManager]
     loginWithPermissions:permissions
     inViewController:delegate.window.rootViewController
     parameters:parameters
     completionHandler:^(LineSDKLoginResult *result, NSError *error) {
      if (result) {
        RCTLogInfo(@"Succeeded login with LINE as %@", result.userProfile.displayName);
        NSURL* pictureUrl = result.userProfile.pictureURL;
        NSString* email = result.accessToken.IDToken.payload.email;
        NSDictionary *user = @{
          @"displayName": result.userProfile.displayName,
          @"pictureUrl": pictureUrl ? pictureUrl.absoluteString : [NSNull null],
          @"email": email ? email : [NSNull null],
          @"idToken": result.accessToken.IDTokenRaw,
        };
        resolve(user);
        return;
      } else {
        RCTLogInfo(@"[%ld]%@(%@)", error.code, error.description, error.localizedRecoverySuggestion);
        if ([error.domain isEqualToString:[LineSDKErrorConstant errorDomain]]) {
          // TODO: handle error
          reject([NSString stringWithFormat:@"%ld", error.code], error.description, error);
          return;
        }
        reject([NSString stringWithFormat:@"%ld", error.code], error.description, error);
        return;
      }
    }];
  });
}

RCT_EXPORT_METHOD(logout: (NSString *) dummy
                  resolver:(RCTPromiseResolveBlock)resolve
                  refector:(RCTPromiseRejectBlock)reject)
{
  [[LineSDKLoginManager sharedManager] logoutWithCompletionHandler:^(NSError *error) {
    if (error) {
      reject([NSString stringWithFormat:@"%ld", error.code], error.description, error);
      return;
    }
    resolve(@"success");
  }];
}
@end
```

`logout` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ Promise ã§æ‰±ãˆã‚‹ã‚ˆã†ã«ãƒ€ãƒŸãƒ¼ã®æ–‡å­—åˆ—ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚ã“ã‚Œã¯ React Native å´ã®åˆ¶ç´„ã€‚

## JavaScript å±¤

ç›´æ¥ `NativeModules` ã‚’ã„ã˜ã‚‹ã‚ˆã‚Šã‚‚ã€æ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«ãƒ©ãƒƒãƒ—ã—ã¦ã‚„ã‚‹ã®ãŒè‰¯ã„ã ã‚ã†ã€‚

```typescript:src/LineLogin.ts
import {NativeModules} from 'react-native';

const {LineLogin} = NativeModules;

export interface Profile {
  idToken: string;
  displayName: string;
  pictureUrl: string;
  email: string;
}
export type Login = (nonce: string) => Promise<Profile>;
export type Logout = () => Promise<void>;

export const login: Login = LineLogin.login;
export const logout: Logout = async function () {
  await LineLogin.logout('dummy');
};
```

`logout` ã«ã¤ã„ã¦ã¯ãƒ€ãƒŸãƒ¼ã®æ–‡å­—åˆ—ã‚’æ¸¡ã—ã¦ã‚„ã£ã¦ã„ã‚‹ã€‚

ã“ã‚Œã§å®Ÿè£…ã¯çµ‚äº†ã€‚å®Ÿéš›ã«ä½¿ã†ã®ã¯æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã€‚

```typescript:App.tsx
import React from 'react';
import {
  Button,
  Image,
  SafeAreaView,
  StyleSheet,
  Text,
  View,
} from 'react-native';
import {login, logout, Profile} from './src/LineLogin';

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
});

function App(): JSX.Element {
  const [profile, setProfile] = React.useState<Profile | null>(null);
  const handleTapLogin = React.useCallback(async () => {
    console.log('login');
    try {
      const result = await login('hoge');
      setProfile(result);
    } catch (e) {
      console.log(e);
    }
  }, []);
  const handleTapLogout = React.useCallback(async () => {
    console.log('logout');
    await logout();
    setProfile(null);
  }, []);
  const isLoggedIn = profile !== null;

  return (
    <SafeAreaView style={styles.container}>
      {isLoggedIn ? (
        <>
          <View>
            <Text>{profile.displayName}</Text>
            <Text>{profile.email}</Text>
            <Image source={{uri: profile.pictureUrl, width: 64, height: 64}} />
          </View>
          <Button title="logout" onPress={handleTapLogout} />
        </>
      ) : (
        <Button title="login" onPress={handleTapLogin} />
      )}
    </SafeAreaView>
  );
}

export default App;
```
